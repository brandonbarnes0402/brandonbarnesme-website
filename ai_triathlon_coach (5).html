<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elite AI Triathlon Coach</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1f2937;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 32px;
            font-weight: 800;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: linear-gradient(135deg, #8b5cf6, #667eea);
            color: white;
            border-radius: 12px;
            font-weight: 600;
        }

        .ai-pulse {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: white;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 14px 28px;
            background: white;
            border: 2px solid transparent;
            border-radius: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
            color: #6b7280;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        /* Views */
        .view-container {
            display: none;
        }

        .view-container.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 500px;
            gap: 24px;
        }

        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            padding: 28px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
        }

        /* Calendar View */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .calendar-day {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            min-height: 140px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .calendar-day:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .calendar-day.rest-day {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
        }

        .calendar-day.completed {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: #10b981;
        }

        .calendar-day-header {
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 8px;
        }

        .calendar-day-date {
            font-size: 11px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .calendar-workout-summary {
            font-size: 11px;
            color: #6b7280;
            line-height: 1.4;
        }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            padding: 20px;
            background: linear-gradient(135deg, #f9fafb, #ffffff);
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Workouts */
        .workout-timeline {
            max-height: 600px;
            overflow-y: auto;
        }

        .day-card {
            padding: 16px;
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s;
        }

        .day-card:hover {
            border-color: #667eea;
            transform: translateX(4px);
        }

        .day-card.completed {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(16, 185, 129, 0.05));
            border-color: #10b981;
        }

        .day-card.rest-day {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
            border-color: #f59e0b;
        }

        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .day-title {
            font-weight: 700;
            font-size: 15px;
        }

        .workout-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .workout-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-size: 14px;
            position: relative;
        }

        .workout-item.swim { border-left-color: #3b82f6; }
        .workout-item.bike { border-left-color: #10b981; }
        .workout-item.run { border-left-color: #f59e0b; }
        .workout-item.strength { border-left-color: #8b5cf6; }

        .btn-edit {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #f59e0b;
            color: white;
            padding: 4px 10px;
            font-size: 11px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-edit:hover {
            background: #d97706;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-complete {
            background: #10b981;
            color: white;
        }

        .btn-custom {
            background: #8b5cf6;
            color: white;
        }

        .btn-skip {
            background: #ef4444;
            color: white;
        }

        .btn-skip:hover {
            background: #dc2626;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* AI Chat */
        .coach-container {
            height: calc(100vh - 200px);
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .message.ai .message-avatar {
            background: linear-gradient(135deg, #8b5cf6, #667eea);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .message-content {
            max-width: 80%;
            padding: 16px;
            border-radius: 16px;
            line-height: 1.6;
        }

        .message.ai .message-content {
            background: white;
            border: 2px solid #e5e7eb;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .typing-indicator {
            display: none;
            padding: 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            width: fit-content;
        }

        .typing-indicator.active {
            display: block;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin: 12px 0;
        }

        .quick-action-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .quick-action-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .chat-input-container {
            display: flex;
            gap: 12px;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 15px;
            font-family: inherit;
            resize: none;
            min-height: 50px;
            max-height: 150px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: #f3f4f6;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 20px;
            color: #6b7280;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #e5e7eb;
            color: #1f2937;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* AI Suggestions */
        .ai-suggestion {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(102, 126, 234, 0.1));
            border: 2px solid #8b5cf6;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .ai-suggestion-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 12px;
        }

        .ai-suggestion-title {
            font-weight: 700;
            color: #5b21b6;
        }

        .ai-suggestion-content {
            color: #6b7280;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .suggestion-actions {
            display: flex;
            gap: 10px;
        }

        /* Charts */
        .chart-container {
            height: 300px;
            margin-top: 20px;
        }

        .chart-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .chart-tab {
            padding: 8px 16px;
            background: #f3f4f6;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chart-tab:hover {
            background: #e5e7eb;
        }

        .chart-tab.active {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div>
                <h1>ü§ñ AI Triathlon Coach</h1>
                <p style="color: #6b7280; margin-top: 8px;">Sprint (May 25) ‚Üí Olympic (Aug 23, 2026)</p>
            </div>
            <div class="header-actions">
                <div class="ai-status">
                    <div class="ai-pulse"></div>
                    <span>Claude Active</span>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchView('training')">
                üìã Training Log
            </button>
            <button class="nav-tab" onclick="switchView('calendar')">
                üìÖ Calendar
            </button>
            <button class="nav-tab" onclick="switchView('analytics')">
                üìä Analytics
            </button>
            <button class="nav-tab" onclick="switchView('coach')">
                ü§ñ AI Coach
            </button>
        </div>

        <!-- Training Log View -->
        <div id="trainingView" class="view-container active">
            <div class="main-grid">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Week <span id="currentWeek">1</span> Training</h3>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-sm" onclick="previousWeek()" style="background: #f3f4f6;">‚Üê Prev</button>
                            <button class="btn btn-sm" onclick="nextWeek()" style="background: #f3f4f6;">Next ‚Üí</button>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Completion Rate</div>
                            <div class="stat-value" id="completionRate">0%</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Training Load</div>
                            <div class="stat-value" id="trainingLoad">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Avg RPE</div>
                            <div class="stat-value" id="avgRPE">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Workouts Done</div>
                            <div class="stat-value" id="workoutsDone">0/7</div>
                        </div>
                    </div>

                    <div id="aiSuggestions"></div>

                    <div class="workout-timeline" id="workoutTimeline"></div>
                </div>

                <div class="card coach-container">
                    <div class="card-header">
                        <h3 class="card-title">üí¨ Quick Coach</h3>
                        <button class="btn btn-sm" onclick="switchView('coach')" style="background: #667eea; color: white;">
                            Full Chat ‚Üí
                        </button>
                    </div>

                    <div class="chat-messages" id="miniChatMessages" style="height: calc(100vh - 450px);">
                        <div class="message ai">
                            <div class="message-avatar">ü§ñ</div>
                            <div class="message-content">
                                <strong>Ready to help!</strong><br>
                                Ask me anything about your training, or switch to Full Chat for detailed conversations.
                            </div>
                        </div>

                        <div class="quick-actions">
                            <button class="quick-action-btn" onclick="sendQuickMessage('How am I doing this week?')">
                                üìä How am I doing?
                            </button>
                            <button class="quick-action-btn" onclick="sendQuickMessage('Should I adjust my plan?')">
                                üîß Adjust plan?
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendarView" class="view-container">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Training Calendar</h3>
                    <button class="btn btn-primary btn-sm" onclick="askCoachAboutCalendar()">
                        üí¨ Ask Coach
                    </button>
                </div>
                <div id="calendarContainer"></div>
            </div>
        </div>

        <!-- Analytics View -->
        <div id="analyticsView" class="view-container">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Training Analytics</h3>
                    <div class="chart-tabs">
                        <button class="chart-tab active" onclick="changeChart('volume')">Volume</button>
                        <button class="chart-tab" onclick="changeChart('load')">Load</button>
                        <button class="chart-tab" onclick="changeChart('rpe')">RPE</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="analyticsChart"></canvas>
                </div>
            </div>

            <div class="card" style="margin-top: 24px;">
                <div class="card-header">
                    <h3 class="card-title">Progress Trends</h3>
                </div>
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
        </div>

        <!-- AI Coach View -->
        <div id="coachView" class="view-container">
            <div class="card coach-container" style="height: calc(100vh - 180px);">
                <div class="card-header">
                    <h3 class="card-title">üí¨ AI Coach - Full Conversation</h3>
                    <button class="btn btn-sm" onclick="resetChat()" style="background: #f3f4f6;">
                        üîÑ Reset
                    </button>
                </div>

                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <strong>Hey! I'm Coach Claude, your AI triathlon coach.</strong><br><br>
                            I analyze your workouts, adjust your plan, answer questions, and keep you on track for both races.<br><br>
                            What would you like to know?
                        </div>
                    </div>

                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="sendQuickMessage('Analyze my week in detail')">
                            üìä Detailed analysis
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('I missed workouts. Help!')">
                            ‚ö†Ô∏è Missed workouts
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('What should I focus on?')">
                            üéØ Weekly focus
                        </button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('Am I ready for the race?')">
                            üèÅ Race readiness
                        </button>
                    </div>

                    <div class="message ai typing-indicator" id="typingIndicator">
                        <div class="message-avatar">ü§ñ</div>
                        <div class="message-content">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="chat-input-container">
                    <textarea 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="Ask your coach anything..."
                        onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Workout Modal -->
    <div id="editWorkoutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚úèÔ∏è Edit Workout</h3>
                <button class="close-btn" onclick="closeEditModal()">√ó</button>
            </div>
            <form onsubmit="saveEditedWorkout(event)">
                <div class="form-group">
                    <label class="form-label">Workout Type</label>
                    <select class="form-control" id="editWorkoutType" required>
                        <option value="SWIM">üèä Swim</option>
                        <option value="BIKE">üö¥ Bike</option>
                        <option value="RUN">üèÉ Run</option>
                        <option value="STRENGTH">üí™ Strength</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Duration (minutes)</label>
                    <input type="number" class="form-control" id="editWorkoutDuration" min="1" max="300" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Distance (optional)</label>
                    <input type="number" class="form-control" id="editWorkoutDistance">
                    <small style="color: #6b7280; font-size: 12px;">Leave blank if not applicable</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="editWorkoutDescription" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    üíæ Save Changes
                </button>
            </form>
        </div>
    </div>

    <!-- Add Custom Workout Modal -->
    <div id="customWorkoutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">‚ûï Add Custom Workout</h3>
                <button class="close-btn" onclick="closeCustomModal()">√ó</button>
            </div>
            <form onsubmit="saveCustomWorkout(event)">
                <div class="form-group">
                    <label class="form-label">Workout Type</label>
                    <select class="form-control" id="customWorkoutType" required>
                        <option value="">Select type...</option>
                        <option value="SWIM">üèä Swim</option>
                        <option value="BIKE">üö¥ Bike</option>
                        <option value="RUN">üèÉ Run</option>
                        <option value="STRENGTH">üí™ Strength</option>
                        <option value="YOGA">üßò Yoga</option>
                        <option value="CROSS_TRAIN">üèãÔ∏è Cross Training</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Duration (minutes)</label>
                    <input type="number" class="form-control" id="customWorkoutDuration" min="1" max="300" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Distance (optional)</label>
                    <input type="number" class="form-control" id="customWorkoutDistance">
                </div>
                <div class="form-group">
                    <label class="form-label">How did it feel?</label>
                    <textarea class="form-control" id="customWorkoutNotes" required></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    üíæ Log Workout
                </button>
            </form>
        </div>
    </div>

    <script>
        // ========== STATE ==========
        let currentWeek = 1;
        let currentView = 'training';
        let currentEditWorkout = null;
        let currentDayKey = null;
        
        let completedWorkouts = JSON.parse(localStorage.getItem('completedWorkouts')) || {};
        let rpeData = JSON.parse(localStorage.getItem('rpeData')) || {};
        let customWorkouts = JSON.parse(localStorage.getItem('customWorkouts')) || {};
        let workoutEdits = JSON.parse(localStorage.getItem('workoutEdits')) || {};
        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];

        // Training Plan
        const trainingPlan = {
            1: {
                dates: "Feb 10-16",
                days: [
                    { day: "Monday", date: "Feb 10", type: "rest", workouts: [
                        { type: "REST", duration: 0, description: "Complete rest or 20-min easy walk" }
                    ]},
                    { day: "Tuesday", date: "Feb 11", type: "swim", workouts: [
                        { type: "SWIM", duration: 45, distance: 700, description: "Technique: 200m warm-up, 8x50m freestyle, drills, 150m cool-down" },
                        { type: "STRENGTH", duration: 40, description: "Upper Body: Push-ups 3x10-12, Rows 3x12, Press 3x10" }
                    ]},
                    { day: "Wednesday", date: "Feb 12", type: "run", workouts: [
                        { type: "RUN", duration: 30, distance: 1600, description: "10 rounds: 1-min jog / 1-min walk (10min total running)" }
                    ]},
                    { day: "Thursday", date: "Feb 13", type: "bike", workouts: [
                        { type: "BIKE", duration: 60, description: "Steady ride with cornering practice every 10 min. Cadence 80-90 RPM." },
                        { type: "STRENGTH", duration: 45, description: "Lower Body: Squats 3x12, Deadlifts 3x8, Lunges 3x10" }
                    ]},
                    { day: "Friday", date: "Feb 14", type: "swim", workouts: [
                        { type: "SWIM", duration: 30, distance: 600, description: "600m easy recovery swim" }
                    ]},
                    { day: "Saturday", date: "Feb 15", type: "swim", workouts: [
                        { type: "SWIM", duration: 45, distance: 1000, description: "Endurance: 300m warm-up, 5x100m, 4x50m kick, 200m cool-down" },
                        { type: "STRENGTH", duration: 35, description: "Upper Body: Pull-ups, Chest Press, Flys" }
                    ]},
                    { day: "Sunday", date: "Feb 16", type: "bike", workouts: [
                        { type: "BIKE", duration: 90, description: "Long ride with bike handling drills and nutrition practice every 15min" },
                        { type: "STRENGTH", duration: 40, description: "Lower Body: Deadlifts, Step-ups, Glute Bridges" }
                    ]}
                ]
            },
            2: {
                dates: "Feb 17-23",
                days: [
                    { day: "Monday", date: "Feb 17", type: "rest", workouts: [{ type: "REST", duration: 0, description: "Rest day" }]},
                    { day: "Tuesday", date: "Feb 18", type: "swim", workouts: [
                        { type: "SWIM", duration: 50, distance: 1150, description: "Building volume: 300m warm-up, 10x50m, 4x100m pull" },
                        { type: "STRENGTH", duration: 40, description: "Upper Body progression" }
                    ]},
                    { day: "Wednesday", date: "Feb 19", type: "run", workouts: [
                        { type: "RUN", duration: 32, distance: 2900, description: "12 rounds: 1.5-min jog / 45-sec walk (18min total!)" }
                    ]},
                    { day: "Thursday", date: "Feb 20", type: "bike", workouts: [
                        { type: "BIKE", duration: 70, description: "Skills + hills: Figure-8s, 2-3 moderate hills" },
                        { type: "STRENGTH", duration: 40, description: "Lower Body with weight progression" }
                    ]},
                    { day: "Friday", date: "Feb 21", type: "swim", workouts: [
                        { type: "SWIM", duration: 30, distance: 500, description: "500m easy recovery" }
                    ]},
                    { day: "Saturday", date: "Feb 22", type: "swim", workouts: [
                        { type: "SWIM", duration: 50, distance: 1300, description: "Technique: 8x75m drill/swim, 3x200m" },
                        { type: "STRENGTH", duration: 35, description: "Upper Body maintenance" }
                    ]},
                    { day: "Sunday", date: "Feb 23", type: "bike", workouts: [
                        { type: "BIKE", duration: 120, description: "Long endurance ride with nutrition practice" },
                        { type: "STRENGTH", duration: 40, description: "Lower Body strength" }
                    ]}
                ]
            }
        };

        // ========== INITIALIZATION ==========
        function init() {
            renderWorkouts();
            renderCalendar();
            updateStats();
            initCharts();
            loadChatHistory();
            
            setTimeout(() => autoAnalyzeAndSuggest(), 2000);
        }

        // ========== VIEW SWITCHING ==========
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');
        }

        // ========== WORKOUTS ==========
        function renderWorkouts() {
            const container = document.getElementById('workoutTimeline');
            const week = trainingPlan[currentWeek];
            if (!week) return;

            container.innerHTML = '';

            week.days.forEach((day, dayIndex) => {
                const dayKey = `w${currentWeek}d${dayIndex}`;
                const isCompleted = completedWorkouts[dayKey];
                
                const dayCard = document.createElement('div');
                dayCard.className = `day-card ${day.type === 'rest' ? 'rest-day' : ''} ${isCompleted ? 'completed' : ''}`;

                let workoutsHTML = '';
                day.workouts.forEach((workout, wIdx) => {
                    const editKey = `${dayKey}w${wIdx}`;
                    const displayWorkout = workoutEdits[editKey] || workout;
                    
                    const icon = displayWorkout.type === 'SWIM' ? 'üèä' : 
                                displayWorkout.type === 'BIKE' ? 'üö¥' : 
                                displayWorkout.type === 'RUN' ? 'üèÉ' : 
                                displayWorkout.type === 'STRENGTH' ? 'üí™' : 'üõå';
                    
                    const workoutClass = displayWorkout.type.toLowerCase();
                    
                    workoutsHTML += `
                        <div class="workout-item ${workoutClass}">
                            ${displayWorkout.type !== 'REST' ? `
                                <button class="btn-edit" onclick="openEditModal('${dayKey}', ${wIdx}, ${JSON.stringify(workout).replace(/"/g, '&quot;')})">
                                    ‚úèÔ∏è Edit
                                </button>
                            ` : ''}
                            <strong>${icon} ${displayWorkout.type}</strong> - ${displayWorkout.duration > 0 ? displayWorkout.duration + 'min' : ''}
                            <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                ${displayWorkout.description}
                            </div>
                            ${displayWorkout.distance ? `
                                <div style="font-size: 12px; color: #667eea; margin-top: 4px; font-weight: 600;">
                                    Target: ${displayWorkout.distance}m
                                </div>
                            ` : ''}
                            ${displayWorkout.edited ? `
                                <div style="font-size: 11px; color: #f59e0b; margin-top: 4px;">
                                    ‚úèÔ∏è Edited from original
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                // Add custom workouts
                const customs = customWorkouts[dayKey] || [];
                if (customs.length > 0) {
                    customs.forEach(custom => {
                        const icon = custom.type === 'SWIM' ? 'üèä' : custom.type === 'BIKE' ? 'üö¥' : 
                                    custom.type === 'RUN' ? 'üèÉ' : custom.type === 'STRENGTH' ? 'üí™' : 'üìã';
                        workoutsHTML += `
                            <div class="workout-item" style="border-left-color: #8b5cf6;">
                                <strong>${icon} ${custom.type}</strong> - ${custom.duration}min <span style="font-size: 11px; opacity: 0.7;">(Custom)</span>
                                <div style="font-size: 13px; color: #6b7280; margin-top: 4px;">
                                    ${custom.notes || custom.description}
                                </div>
                            </div>
                        `;
                    });
                }

                dayCard.innerHTML = `
                    <div class="day-header">
                        <div class="day-title">${day.day} ${isCompleted ? '‚úÖ' : ''}</div>
                        ${day.type !== 'rest' ? `
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-custom" onclick="openCustomModal('${dayKey}')">
                                    + Custom
                                </button>
                                <button class="btn btn-sm btn-skip" onclick="skipDay('${dayKey}')">
                                    Skip
                                </button>
                                <button class="btn btn-sm btn-complete" onclick="markComplete('${dayKey}')">
                                    ${isCompleted ? '‚úì Done' : 'Complete'}
                                </button>
                            </div>
                        ` : `
                            <button class="btn btn-sm btn-complete" onclick="markComplete('${dayKey}')">
                                ${isCompleted ? '‚úì Rested' : 'Mark Rested'}
                            </button>
                        `}
                    </div>
                    <div class="day-date">${day.date}</div>
                    <div class="workout-list" style="margin-top: 12px;">
                        ${workoutsHTML}
                    </div>
                `;

                container.appendChild(dayCard);
            });

            document.getElementById('currentWeek').textContent = currentWeek;
        }

        function markComplete(dayKey) {
            completedWorkouts[dayKey] = !completedWorkouts[dayKey];
            localStorage.setItem('completedWorkouts', JSON.stringify(completedWorkouts));
            renderWorkouts();
            renderCalendar();
            updateStats();
            
            setTimeout(() => autoAnalyzeAndSuggest(), 1000);
        }

        function skipDay(dayKey) {
            if (confirm('Skip this day? This will mark it as intentionally skipped (not completed).')) {
                completedWorkouts[dayKey] = 'skipped';
                localStorage.setItem('completedWorkouts', JSON.stringify(completedWorkouts));
                renderWorkouts();
                renderCalendar();
                updateStats();
                
                setTimeout(() => autoAnalyzeAndSuggest(), 1000);
            }
        }

        function previousWeek() {
            if (currentWeek > 1) {
                currentWeek--;
                renderWorkouts();
                updateStats();
            }
        }

        function nextWeek() {
            if (currentWeek < 8 && trainingPlan[currentWeek + 1]) {
                currentWeek++;
                renderWorkouts();
                updateStats();
            }
        }

        // ========== EDIT WORKOUT ==========
        function openEditModal(dayKey, workoutIndex, workout) {
            currentEditWorkout = { dayKey, workoutIndex, workout };
            const editKey = `${dayKey}w${workoutIndex}`;
            const edited = workoutEdits[editKey] || workout;

            document.getElementById('editWorkoutType').value = edited.type;
            document.getElementById('editWorkoutDuration').value = edited.duration;
            document.getElementById('editWorkoutDistance').value = edited.distance || '';
            document.getElementById('editWorkoutDescription').value = edited.description;
            
            document.getElementById('editWorkoutModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editWorkoutModal').classList.remove('active');
            currentEditWorkout = null;
        }

        function saveEditedWorkout(event) {
            event.preventDefault();
            
            const { dayKey, workoutIndex } = currentEditWorkout;
            const editKey = `${dayKey}w${workoutIndex}`;

            workoutEdits[editKey] = {
                type: document.getElementById('editWorkoutType').value,
                duration: parseInt(document.getElementById('editWorkoutDuration').value),
                distance: document.getElementById('editWorkoutDistance').value ? 
                         parseInt(document.getElementById('editWorkoutDistance').value) : null,
                description: document.getElementById('editWorkoutDescription').value,
                edited: true
            };

            localStorage.setItem('workoutEdits', JSON.stringify(workoutEdits));
            closeEditModal();
            renderWorkouts();
            renderCalendar();
            updateStats();
        }

        // ========== CUSTOM WORKOUT ==========
        function openCustomModal(dayKey) {
            currentDayKey = dayKey;
            document.getElementById('customWorkoutType').value = '';
            document.getElementById('customWorkoutDuration').value = '';
            document.getElementById('customWorkoutDistance').value = '';
            document.getElementById('customWorkoutNotes').value = '';
            document.getElementById('customWorkoutModal').classList.add('active');
        }

        function closeCustomModal() {
            document.getElementById('customWorkoutModal').classList.remove('active');
            currentDayKey = null;
        }

        function saveCustomWorkout(event) {
            event.preventDefault();
            
            const custom = {
                type: document.getElementById('customWorkoutType').value,
                duration: parseInt(document.getElementById('customWorkoutDuration').value),
                distance: document.getElementById('customWorkoutDistance').value ? 
                         parseInt(document.getElementById('customWorkoutDistance').value) : null,
                notes: document.getElementById('customWorkoutNotes').value,
                timestamp: new Date().toISOString()
            };

            if (!customWorkouts[currentDayKey]) {
                customWorkouts[currentDayKey] = [];
            }
            
            customWorkouts[currentDayKey].push(custom);
            localStorage.setItem('customWorkouts', JSON.stringify(customWorkouts));
            
            closeCustomModal();
            renderWorkouts();
            renderCalendar();
            updateStats();
        }

        // ========== CALENDAR ==========
        function renderCalendar() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';

            for (let weekNum = 1; weekNum <= 2; weekNum++) {
                const week = trainingPlan[weekNum];
                if (!week) continue;

                const weekHeader = document.createElement('h3');
                weekHeader.textContent = `Week ${weekNum}: ${week.dates}`;
                weekHeader.style.marginTop = weekNum > 1 ? '32px' : '0';
                weekHeader.style.marginBottom = '16px';
                container.appendChild(weekHeader);

                const grid = document.createElement('div');
                grid.className = 'calendar-grid';

                week.days.forEach((day, idx) => {
                    const dayKey = `w${weekNum}d${idx}`;
                    const isCompleted = completedWorkouts[dayKey];
                    
                    const dayCard = document.createElement('div');
                    dayCard.className = `calendar-day ${day.type === 'rest' ? 'rest-day' : ''} ${isCompleted ? 'completed' : ''}`;
                    dayCard.onclick = () => {
                        currentWeek = weekNum;
                        switchView('training');
                        renderWorkouts();
                    };

                    let summary = '';
                    day.workouts.forEach(w => {
                        if (w.type !== 'REST') {
                            const icon = w.type === 'SWIM' ? 'üèä' : w.type === 'BIKE' ? 'üö¥' : w.type === 'RUN' ? 'üèÉ' : 'üí™';
                            summary += `${icon} ${w.duration}m<br>`;
                        }
                    });

                    dayCard.innerHTML = `
                        <div class="calendar-day-header">${day.day}</div>
                        <div class="calendar-day-date">${day.date}</div>
                        <div class="calendar-workout-summary">${summary || 'üõå Rest'}</div>
                        ${isCompleted ? '<div style="text-align: center; margin-top: 8px;">‚úÖ</div>' : ''}
                    `;

                    grid.appendChild(dayCard);
                });

                container.appendChild(grid);
            }
        }

        // ========== STATS ==========
        function updateStats() {
            const context = getTrainingContext();
            
            document.getElementById('completionRate').textContent = context.completionRate;
            document.getElementById('trainingLoad').textContent = Math.round(context.totalTrainingMinutes * 1.5);
            document.getElementById('avgRPE').textContent = context.avgRPE || '-';
            document.getElementById('workoutsDone').textContent = 
                `${context.completedWorkouts}/${context.totalWorkouts}`;
        }

        function getTrainingContext() {
            const week = trainingPlan[currentWeek];
            if (!week) return {};

            let completed = 0, total = 0, totalMinutes = 0;
            let swimDist = 0, bikeTime = 0, runDist = 0;

            week.days.forEach((day, idx) => {
                const dayKey = `w${currentWeek}d${idx}`;
                
                day.workouts.forEach(workout => {
                    if (workout.type !== 'REST') total++;
                });

                if (completedWorkouts[dayKey]) {
                    completed++;
                    day.workouts.forEach(w => {
                        totalMinutes += w.duration || 0;
                        if (w.type === 'SWIM' && w.distance) swimDist += w.distance;
                        if (w.type === 'BIKE' && w.duration) bikeTime += w.duration;
                        if (w.type === 'RUN' && w.distance) runDist += w.distance;
                    });
                }
            });

            return {
                currentWeek,
                totalWorkouts: total,
                completedWorkouts: completed,
                completionRate: total > 0 ? ((completed / total) * 100).toFixed(0) + '%' : '0%',
                totalTrainingMinutes: totalMinutes,
                swimDistance: swimDist,
                bikeTimeMinutes: bikeTime,
                runDistance: runDist,
                missedWorkouts: total - completed,
                weekDates: week.dates
            };
        }

        // ========== CHARTS ==========
        let analyticsChart, progressChart;

        function initCharts() {
            const analyticsCtx = document.getElementById('analyticsChart');
            if (analyticsCtx) {
                analyticsChart = new Chart(analyticsCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: [
                            {
                                label: 'Swim (m)',
                                data: [0, 700, 0, 0, 600, 1000, 0],
                                backgroundColor: 'rgba(59, 130, 246, 0.7)',
                                borderRadius: 8
                            },
                            {
                                label: 'Bike (min)',
                                data: [0, 0, 0, 60, 0, 0, 90],
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                borderRadius: 8
                            },
                            {
                                label: 'Run (min)',
                                data: [0, 0, 30, 0, 0, 0, 0],
                                backgroundColor: 'rgba(245, 158, 11, 0.7)',
                                borderRadius: 8
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom' } }
                    }
                });
            }

            const progressCtx = document.getElementById('progressChart');
            if (progressCtx) {
                progressChart = new Chart(progressCtx, {
                    type: 'line',
                    data: {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        datasets: [{
                            label: 'Completion Rate %',
                            data: [85, 75, 90, 0],
                            borderColor: 'rgb(102, 126, 234)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            borderWidth: 3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }
        }

        function changeChart(type) {
            document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            // Update chart data based on type
        }

        // ========== AI COACH ==========
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addMessage('user', message);
            input.value = '';
            showTyping(true);

            await getCoachResponse(message);
        }

        function sendQuickMessage(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }

        async function getCoachResponse(userMessage) {
            try {
                const trainingContext = getTrainingContext();
                
                const systemPrompt = `You are an expert triathlon coach with 15+ years of experience coaching beginners. You're coaching an athlete training for:
- Sprint Triathlon: May 25, 2026 (750m swim / 20km bike / 5km run)
- Olympic Triathlon: Aug 23, 2026 (1.5km swim / 40km bike / 10km run)

Current training data:
${JSON.stringify(trainingContext, null, 2)}

Coaching style:
- Evidence-based and scientific
- Empathetic and encouraging
- Focus on sustainability over intensity
- Emphasize injury prevention
- Provide specific, actionable advice

When analyzing:
1. Look at completion rates and suggest adjustments if <80%
2. Analyze trends to detect overtraining or undertraining
3. Provide specific workout modifications when needed
4. Celebrate progress
5. Give clear recommendations

Keep responses conversational, warm, and under 150 words unless providing detailed analysis.`;

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        system: systemPrompt,
                        messages: [
                            ...chatHistory.slice(-10),
                            { role: "user", content: userMessage }
                        ]
                    })
                });

                const data = await response.json();
                const aiMessage = data.content[0].text;

                showTyping(false);
                addMessage('ai', aiMessage);

            } catch (error) {
                showTyping(false);
                addMessage('ai', "I'm having trouble connecting right now. Please try again in a moment.");
                console.error('AI Error:', error);
            }
        }

        async function autoAnalyzeAndSuggest() {
            const context = getTrainingContext();
            if (context.totalWorkouts === 0) return;

            const lastAnalysis = localStorage.getItem('lastAutoAnalysis');
            const weekKey = `w${currentWeek}`;
            if (lastAnalysis === weekKey) return;

            try {
                const systemPrompt = `Analyze this training data and provide ONE key insight (2-3 sentences max):

${JSON.stringify(context, null, 2)}

Format:
**[Title]**
[Brief explanation and specific recommendation]`;

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 300,
                        messages: [
                            { role: "user", content: "Analyze my training and give me your top recommendation." }
                        ],
                        system: systemPrompt
                    })
                });

                const data = await response.json();
                const suggestion = data.content[0].text;

                displayAISuggestion(suggestion);
                localStorage.setItem('lastAutoAnalysis', weekKey);

            } catch (error) {
                console.error('Auto-analysis error:', error);
            }
        }

        function displayAISuggestion(suggestion) {
            const container = document.getElementById('aiSuggestions');
            container.innerHTML = `
                <div class="ai-suggestion">
                    <div class="ai-suggestion-header">
                        <span style="font-size: 20px;">ü§ñ</span>
                        <span class="ai-suggestion-title">Coach's Insight</span>
                    </div>
                    <div class="ai-suggestion-content">
                        ${suggestion.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}
                    </div>
                    <div class="suggestion-actions">
                        <button class="btn btn-sm btn-primary" onclick="askAboutSuggestion()">
                            Tell me more
                        </button>
                        <button class="btn btn-sm" onclick="dismissSuggestion()" style="background: #f3f4f6;">
                            Got it
                        </button>
                    </div>
                </div>
            `;
        }

        function askAboutSuggestion() {
            const suggestion = document.querySelector('.ai-suggestion-content').textContent;
            switchView('coach');
            setTimeout(() => {
                sendQuickMessage(`Can you explain more about: ${suggestion.substring(0, 100)}...`);
            }, 300);
            dismissSuggestion();
        }

        function dismissSuggestion() {
            document.getElementById('aiSuggestions').innerHTML = '';
        }

        function askCoachAboutCalendar() {
            switchView('coach');
            setTimeout(() => {
                sendQuickMessage('Give me an overview of my training calendar and what I should focus on.');
            }, 300);
        }

        function addMessage(sender, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'ai' ? 'ü§ñ' : 'üë§';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">
                    ${content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}
                </div>
            `;
            
            messagesContainer.insertBefore(messageDiv, typingIndicator);
            
            chatHistory.push({ role: sender === 'ai' ? 'assistant' : 'user', content });
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory.slice(-20)));
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping(show) {
            const indicator = document.getElementById('typingIndicator');
            indicator.classList.toggle('active', show);
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = show;
        }

        function loadChatHistory() {
            const messagesContainer = document.getElementById('chatMessages');
            
            chatHistory.forEach(msg => {
                if (msg.role !== 'system') {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${msg.role === 'assistant' ? 'ai' : 'user'}`;
                    
                    const avatar = msg.role === 'assistant' ? 'ü§ñ' : 'üë§';
                    
                    messageDiv.innerHTML = `
                        <div class="message-avatar">${avatar}</div>
                        <div class="message-content">
                            ${msg.content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>')}
                        </div>
                    `;
                    
                    const typingIndicator = document.getElementById('typingIndicator');
                    messagesContainer.insertBefore(messageDiv, typingIndicator);
                }
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function resetChat() {
            if (confirm('Clear chat history?')) {
                chatHistory = [];
                localStorage.setItem('chatHistory', JSON.stringify([]));
                
                const messagesContainer = document.getElementById('chatMessages');
                const existingMessages = messagesContainer.querySelectorAll('.message:not(.typing-indicator)');
                existingMessages.forEach(msg => {
                    if (!msg.querySelector('.message-content').textContent.includes("I'm Coach Claude")) {
                        msg.remove();
                    }
                });
            }
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }

        // Initialize
        init();
    </script>
</body>
</html>